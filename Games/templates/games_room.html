{% extends "base.html" %}
{% load static %}

{% block title %}Sala: {{ game.room_name }} - Tic Tac Toe{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200 mb-8">
        <div class="flex justify-between items-center mb-4">
            <div>
                
                <h1 class="text-3xl font-bold text-gray-800">üéÆ {{ game.room_name }}</h1>
                <p class="text-gray-600">
                    Estado: 
                    <span id= "winnerMsg" class="font-semibold {% if not game.over %}text-green-600{% else %}text-blue-600{% endif %}">
                        {% if game.winner %}Gan√≥ {{ game.winner }}
                        {% elif game.over %}Empate
                        {% else %}En juego{% endif %}
                    </span>
                </p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600">Tu eres: <span class="font-semibold">{{ user.username }}</span></p>
                {% if game.over %}
                <form method="post" action="{% url 'Games:delete_game' game.room_name %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors mt-2 flex items-center space-x-2">
                        <span>üóëÔ∏è</span>
                        <span>Cerrar Sala</span>
                    </button>
                </form>
                {% endif %}
                <a href="{% url 'Games:games_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors mt-2 ml-2 inline-block">
                    ‚Üê Volver
                </a>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="{% if game.active_player == 1 and not game.over %}bg-green-50 border-green-300{% else %}bg-blue-50 border-blue-200{% endif %} rounded-lg p-4 border-2 transition-colors">
                <h3 class="font-semibold {% if game.active_player == 1 and not game.over %}text-green-800{% else %}text-blue-800{% endif %} mb-2 flex items-center">
                    <span class="text-lg mr-2">üë§</span>
                    Jugador 1 (X) - {{ game.owner.username }}
                </h3>
                {% if game.active_player == 1 and not game.over %}
                <span id="nextTurn1" class="block mt-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual
                </span>
                {% else %}

                <span id="nextTurn1" class="hidden mt-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual 
                </span>

                {% endif %}
            </div>
            
            <div class="{% if game.active_player == 2 and not game.over %}bg-green-50 border-green-300{% else %}
                {% if game.player2 %}bg-green-50 border-green-200{% else %}bg-gray-100 border-gray-300{% endif %}
                {% endif %} rounded-lg p-4 border-2 transition-colors">
                <h3 class="font-semibold {% if game.active_player == 2 and not game.over %}text-green-800{% else %}
                    {% if game.player2 %}text-green-800{% else %}text-gray-600{% endif %}{% endif %} mb-2 flex items-center">
                    <span class="text-lg mr-2">üë•</span>
                    Jugador 2 (O) - {% if game.player2 %}{{ game.player2.username }}{% else %}Esperando...{% endif %}
                </h3>
                {% if game.active_player == 2 and not game.over %}
                <span id="nextTurn2" class="block mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual
                </span>
                {% else %}
                <span id="nextTurn2" class="hidden mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual
                </span>
                {% endif %}
            </div>
        </div>

        {% if not game.player2 and user != game.owner %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
            <p class="text-yellow-800 font-semibold">‚ö†Ô∏è Eres el jugador 2. Tu s√≠mbolo ser√°: ‚≠ï</p>
        </div>
        {% endif %}
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Tablero</h2>
            
            {% if not game.over %}
                <p class="text-center text-lg mb-4">
                    Turno de: 
                    <span id= "cambioTurno" class="font-bold {% if game.active_player == 1 %}text-blue-600{% else %}text-green-600{% endif %}">
                        {% if game.active_player == 1 %}
                            {{ game.owner.username }} (‚ùå)
                        {% else %}
                            {% if game.player2 %}{{ game.player2.username }}{% else %}Jugador 2{% endif %} (‚≠ï)
                        {% endif %}
                    </span>
                </p>
            {% else %}
                <div class="text-center mb-4 p-4 {% if game.winner %}bg-yellow-50 border-yellow-200{% else %}
                      bg-purple-50 border-purple-200
                        {% endif %} rounded-lg border">
                    <p class="text-xl font-bold {% if game.winner %}text-yellow-800{% else %}text-purple-800{% endif %}">
                        {% if game.winner %} 
                            üéâ ¬°{{ game.winner }} gana!
                        {% else %}
                            ü§ù ¬°Empate!
                        {% endif %}
                    </p>
                </div>
            {% endif %}

            <div class="grid grid-cols-3 gap-3 max-w-md mx-auto mb-6">
                {% for square in board %}
                    <button id= "square" name="square" value="{{ forloop.counter0 }}"
                            class="w-full h-full border-2 rounded-lg text-4xl font-bold transition-all duration-200
                                   {% if square == 'X' %}text-blue-600 bg-blue-50 border-blue-300
                                   {% elif square == 'O' %}text-green-600 bg-green-50 border-green-300
                                   {% else %}text-gray-400 border-gray-300 hover:bg-gray-50{% endif %}
                                   {% if game.over or square != '-' %}opacity-50 cursor-not-allowed{% endif %}"
                            {% if game.over or square != '-' %}disabled{% endif %}
                            {% if square == '-' and not game.over %}title="Hacer movimiento en posici√≥n {{ forloop.counter0 }}"{% endif %}>
                        {% if square == 'X' %}‚ùå
                        {% elif square == 'O' %}‚≠ï
                        {% else %}&nbsp;{% endif %}
                    </button>
                {% endfor %}
            </div>

            <div class="text-center space-y-3">
                <div class="text-sm text-gray-600">
                    <p>‚ùå = Jugador 1 ({{ game.owner.username }}) | ‚≠ï = Jugador 2 ({% if game.player2 %}{{ game.player2.username }}
                        {% else %}?{% endif %})</p>
                </div>
                
                {% if game.over %}
                <div class="flex justify-center space-x-4">
                    <a href="{% url 'Games:games_list' %}" class="bg-blue-500 hover:bg-blue-600 text-white 
                             px-6 py-2 rounded-lg font-semibold transition-colors">
                        üè† Volver al Listado
                    </a>
                    {% if user == game.owner %}
                    <form method="post" action="{% url 'Games:delete_game' game.room_name %}" class="inline">
                        {% csrf_token %}
                        <button id= "deletePanel" type="submit" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            üóëÔ∏è Eliminar Sala
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Informaci√≥n del Juego</h2>
            
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">Estado Actual</h3>
                    <div class="space-y-2 text-sm">
                        <p><span class="font-medium">Sala:</span> {{ game.room_name }}</p>
                        <p><span class="font-medium">Creador:</span> {{ game.owner.username }}</p>
                        <p><span class="font-medium">Jugador 2:</span> {% if game.player2 %}{{ game.player2.username }}{% else %}Por unirse{% endif %}</p>
                        <p id="nextTurn" ><span class="font-medium">Turno:
                                {% if game.over %}Juego terminado
                                {% elif game.active_player == 1 %}{{ game.owner.username }} (‚ùå)
                                {% else %}{% if game.player2 %}{{ game.player2.username }}{% else %}Jugador 2{% endif %} (‚≠ï)
                                {% endif %}
                            </span>
                        </p>
                    </div>
                </div>

                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">üìã Instrucciones</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ Haz clic en una casilla vac√≠a para colocar tu s√≠mbolo</li>
                        <li>‚Ä¢ Alterna turnos con el otro jugador</li>
                        <li>‚Ä¢ Gana alinear 3 s√≠mbolos iguales</li>
                        <li>‚Ä¢ El juego termina con victoria o empate</li>
                    </ul>
                </div>

                {% if not game.over %}
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">üéØ Tu Rol</h3>
                    <p class="text-sm text-green-700">
                        {% if user == game.owner %}
                            Eres el <span class="font-bold">Jugador 1 (‚ùå)</span>
                        {% elif user == game.player2 %}
                            Eres el <span class="font-bold">Jugador 2 (‚≠ï)</span>
                        {% else %}
                            Eres un <span class="font-bold">Espectador</span>
                        {% endif %}
                    </p>
                    {% if not game.player2 and user != game.owner %}
                    <p class="text-sm text-green-600 mt-1">¬°Ser√°s el Jugador 2 cuando te unas!</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>



<script>
    const user_id = {{ user.id }};
    const roomName = "{{ game.room_name }}";
    const gameSocket = new WebSocket(
        'ws://' + window.location.host +'/ws/tictactoe/' + roomName + '/');

    gameSocket.onopen = function(e) {
        console.log("Connected to socket.");
    };

    gameSocket.onmessage = function(e) {
        const received = JSON.parse(e.data);
        if (received.game_state) {
            console.log("Estado recibido: ", received.game_state);
            const boardArr = received.game_state.board.split('');
            document.querySelectorAll('#square').forEach((btn, i) => {
                btn.textContent = boardArr[i];
            });
            
            document.getElementById('nextTurn').textContent = "Jugador actual: " + received.game_state.active_player;
            document.getElementById('cambioTurno').textContent = 
                received.game_state.active_player === 1 ? received.game_state.player1 + " (‚ùå)" : 
                (received.game_state.player2 ? received.game_state.active_player : "Jugador 2") + " (‚≠ï)";
                //rescreibir a ifs pqra no liarme 

            if (received.game_state.active_player === 1) {
                console.log("Turno del jugador 1");
                document.getElementById('nextTurn1').style.display = 'block';
                document.getElementById('nextTurn2').style.display = 'none';
            }
            else {
                document.getElementById('nextTurn1').style.display = 'none';
                document.getElementById('nextTurn2').style.display = 'block';
            }
            
            if (received.game_state.over) {
                document.getElementById('nextTurn').textContent = "Turno: Juego terminado";
                if (received.game_state.winner) {
                    document.getElementById('winnerMsg').textContent = "Gan√≥ " + received.game_state.winner;
                } else {
                    document.getElementById('winnerMsg').textContent = "Empate";
                }
            } else {
                document.getElementById('winnerMsg').textContent = "En juego";
            }
        };
    };

    document.querySelectorAll('#square').forEach(btn => {
    btn.onclick = function(event) {
        event.preventDefault();
        if (gameSocket.readyState === WebSocket.OPEN) {
            gameSocket.send(JSON.stringify({
                'move': btn.value,
                'user': user_id
            }));
        } else {
            alert("Conexi√≥n perdida con el servidor. Recarga la p√°gina.");
        }
        };
    });

    
</script>
{% endblock %}