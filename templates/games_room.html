{% extends "base.html" %}
{% load static %}

{% block title %}Sala: {{ game.room_name }} - Tic Tac Toe{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200 mb-8">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">üéÆ {{ game.room_name }}</h1>
                <p class="text-gray-600">Estado: 
                    <span class="font-semibold {% if game.game_state == 'active' %}text-green-600{% else %}text-blue-600{% endif %}">
                        {{ game.get_game_state_display }}
                    </span>
                </p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600">Tu eres: <span class="font-semibold">{{ request.user.username }}</span></p>
                {% if game.game_state != 'active' %}
                <form method="post" action="{% url 'games:delete_game' game.id %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors mt-2">
                        üóëÔ∏è Cerrar Sala
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2">üë§ Jugador 1 (X)</h3>
                <p class="text-blue-700">{{ game.owner.username }}</p>
                {% if game.active_player == 'X' and game.game_state == 'active' %}
                <span class="inline-block mt-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual
                </span>
                {% endif %}
            </div>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <h3 class="font-semibold text-green-800 mb-2">üë• Jugador 2 (O)</h3>
                <p class="text-green-700">
                    {% if game.player2 %}
                        {{ game.player2.username }}
                    {% else %}
                        Esperando jugador...
                    {% endif %}
                </p>
                {% if game.active_player == 'O' and game.game_state == 'active' %}
                <span class="inline-block mt-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ‚úÖ Turno Actual
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Tablero</h2>
            
            {% if game.game_state == 'active' %}
                <p class="text-center text-lg mb-4">
                    Turno de: 
                    <span class="font-bold {% if game.active_player == 'X' %}text-blue-600{% else %}text-green-600{% endif %}">
                        Jugador {{ game.active_player }}
                    </span>
                </p>
            {% else %}
                <div class="text-center mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <p class="text-xl font-bold text-yellow-800">
                        {% if game.game_state == 'won_p1' %}üéâ ¬°Jugador X ({{ game.owner.username }}) gana!
                        {% elif game.game_state == 'won_p2' %}üéâ ¬°Jugador O ({% if game.player2 %}{{ game.player2.username }}{% endif %}) gana!
                        {% else %}ü§ù ¬°Empate!{% endif %}
                    </p>
                </div>
            {% endif %}

           
            <div class="grid grid-cols-3 gap-3 max-w-md mx-auto mb-6">
                {% for square in game.board %}
                <form method="post" action="{% url 'games:make_move' game.id %}" class="aspect-square">
                    {% csrf_token %}
                    <input type="hidden" name="square" value="{{ forloop.counter0 }}">
                    <button type="submit" 
                            class="w-full h-full border-2 border-gray-300 rounded-lg text-4xl font-bold transition-all duration-200 hover:bg-gray-50
                                   {% if square == 'X' %}text-blue-600 bg-blue-50 border-blue-300
                                   {% elif square == 'O' %}text-green-600 bg-green-50 border-green-300
                                   {% else %}text-gray-400{% endif %}
                                   {% if game.game_state != 'active' or square != '' %}opacity-50 cursor-not-allowed{% endif %}"
                            {% if game.game_state != 'active' or square != '' %}disabled{% endif %}>
                        {% if square == 'X' %}‚ùå
                        {% elif square == 'O' %}‚≠ï
                        {% else %}&nbsp;{% endif %}
                    </button>
                </form>
                {% endfor %}
            </div>

           
            <div class="text-center text-sm text-gray-600">
                <p>‚ùå = Jugador 1 (X) | ‚≠ï = Jugador 2 (O)</p>
            </div>
        </div>

        
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üí¨ Chat en Vivo</h2>
            
           
            <div id="chat-messages" class="h-64 overflow-y-auto mb-4 border border-gray-200 rounded-lg p-4 bg-gray-50">
                {% for msg in messages_list %}
                <div class="mb-3">
                    <div class="flex justify-between items-start">
                        <span class="font-semibold text-blue-600">{{ msg.user.username }}</span>
                        <span class="text-xs text-gray-500">{{ msg.timestamp|date:"H:i" }}</span>
                    </div>
                    <p class="text-gray-700 mt-1">{{ msg.message }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="flex gap-2">
                <input type="text" 
                       id="chat-message-input" 
                       placeholder="Escribe tu mensaje..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="chat-message-submit" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>

{{ game_data|json_script:"game-data" }}

<script>
    const gameData = JSON.parse(document.getElementById('game-data').textContent);
    const currentUser = '{{ request.user.username }}';
    const currentUserId = {{ request.user.id }};
    const roomId = {{ game.id }};

    const gameSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/game/' + roomId + '/'
    );

    gameSocket.onopen = function(e) {
        console.log('Conectado al WebSocket del juego');
        
        if (gameSocket.readyState === WebSocket.OPEN) {
            gameSocket.send(JSON.stringify({
                'type': 'player_joined',
                'username': currentUser
            }));
        }
    };

    gameSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-3';
            messageDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="font-semibold text-blue-600">${data.username}</span>
                    <span class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <p class="text-gray-700 mt-1">${data.message}</p>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
        } else if (data.type === 'game_update') {
            location.reload(); 
            
        } else if (data.type === 'player_joined') {
            const chatMessages = document.getElementById('chat-messages');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'mb-3 text-center';
            notificationDiv.innerHTML = `
                <p class="text-sm text-gray-500 bg-yellow-100 py-1 rounded">${data.message}</p>
            `;
            chatMessages.appendChild(notificationDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };

    gameSocket.onclose = function(e) {
        console.log('Conexi√≥n WebSocket cerrada');
    };

    document.getElementById('chat-message-submit').addEventListener('click', function() {
        const messageInput = document.getElementById('chat-message-input');
        const message = messageInput.value.trim();
        
        if (message && gameSocket.readyState === WebSocket.OPEN) {
            gameSocket.send(JSON.stringify({
                'type': 'chat_message',
                'room_id': roomId,
                'user_id': currentUserId,
                'username': currentUser,
                'message': message
            }));
            messageInput.value = '';
        }
    });

    document.getElementById('chat-message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('chat-message-submit').click();
        }
    });

    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}